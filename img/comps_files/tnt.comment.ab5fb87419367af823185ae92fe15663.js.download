window.__tnt||(window.__tnt={}),__tnt.comment||(__tnt.comment={}),__tnt.comment.post={clear:function(t){t.find("button,textarea").removeAttr("disabled"),t.find("button[type=submit]").button("reset"),t.find(".form-body").find("#comment-reply-preview").remove(),t.find("input[name=parent_uuid]").remove(),t.find("textarea[name=comment]").val(""),t.find(".alert").text("").hide()},prepare:function(t,e){if(""!=e){var n=$("#comment-"+e).clone();n.attr("id","comment-reply-preview"),n.find(".comment-options").remove(),n.find(".comment-footer").remove(),n.find(".replies").remove(),n.append("<hr/>"),t.find(".modal-body").prepend(n),t.append('<input type="hidden" name="parent_uuid" value="'+e+'"/>')}},data:function(t){var e=t.find("input[name=app]").val(),n=t.find("input[name=id]").val(),o="",a="";return""!=t.find("textarea[name=comment]").val()&&(a=t.find("textarea[name=comment]").val()),t.find("input[name=parent_uuid]").length&&(o=t.find("input[name=parent_uuid]").val()),this.obj=new Object({id:n,app:e,comment:a,parent_uuid:o}),null==__tnt.user.authToken&&(t.find("input[name=alias]")&&(this.obj.alias=t.find("input[name=alias]").val()),t.find("input[name=tncms_captcha_id]")&&(this.obj.tncms_captcha_id=t.find("input[name=tncms_captcha_id]").val(),this.obj.tncms_captcha_response=t.find("input[name=tncms_captcha_response]").val()),t.find("textarea.g-recaptcha-response")&&(this.obj["g-recaptcha-response"]=t.find("textarea.g-recaptcha-response").val())),this.obj}},__tnt.comment.abuse={prepare:function(t,e){t.find(".modal-body").html("");var n=$("#comment-"+e).clone();n.attr("id","comment-report-preview"),n.find(".comment-options").remove(),n.find(".comment-footer").remove(),n.find(".replies").remove(),t.find(".modal-body").prepend(n),t.find("input[name=comment_id]").val(e)}},__tnt.comment.subscribe={prepare:function(){try{window.localStorage&&localStorage.getItem("comment-subscribed-"+$("#asset-content").attr("data-asset-uuid"))&&__tnt.comment.subscribe.toggle()}catch(t){}},toggle:function(){var t=$("#commentSubscribe");if(t.length){var e=t.attr("action"),n=["/subscribe/","/unsubscribe/"];e.search(/\/subscribe\//)<0&&n.reverse(),t.attr("action",$("#commentSubscribe").attr("action").replace(n[0],n[1])),$("#commentSubscribeModal").find(".subscribe, .unsubscribe").toggle(),$("#comments").find(".watch span").toggle()}},set:function(){var t=$("#asset-content").attr("data-asset-uuid");try{window.localStorage&&localStorage.setItem("comment-subscribed-"+t,1)}catch(e){}},unset:function(){var t=$("#asset-content").attr("data-asset-uuid");try{window.localStorage&&localStorage.removeItem("comment-subscribed-"+t)}catch(e){}}},__tnt.comment.preview={append:function(t,e){t.length&&$.each(t,function(){__tnt.comment.preview.create(this.data,$("#commentPostModal").find(".template.success"),e)})},create:function(t,e,n){var o=n.hasClass("desc"),a=__tnt.comment.preview.sanitize(t.comment);if(""!=t.parent_uuid){var m=$("#comment-"+t.parent_uuid);m.find(".replies").length||m.append('<div class="replies"></div>'),n=m.find(".replies").first()}var i=[{element:"img.avatar",attr:[{attr:"src",value:__tnt.user.avatar}]},{element:".comment-text",html:"<p>"+a+"</p>"}];null!=__tnt.user.authToken?i.push({element:".username",html:__tnt.user.screenName}):""!=t.alias&&i.push({element:".username",html:t.alias}),__tnt.template(e[0],n[0],o,i,function(t){null!=__tnt.user.avatar?$(t).find("div.avatar").remove():($(t).find("img.avatar").remove(),null==__tnt.user.authToken&&($(t).find("div.avatar").find("i").removeClass("fa-user").addClass("fa-user-secret"),$(t).find("div.avatar").find("[data-fa-i2svg]").attr("data-icon","user-secret")))}),__tnt.emoticon.handle($(".comment.preview .comment-text"))},sanitize:function(t){return"string"==typeof t&&(t=t.replace(/<?\/?script[\w\W\s=" :\']*?>/g,"")),t},store:function(t,e){var n=!1;try{if(window.sessionStorage){var o=new Array,a=new Date,m="",i=0;null!=sessionStorage.getItem("comment-previews")&&(o=JSON.parse(sessionStorage.getItem("comment-previews"))),m=a.getTime("u"),i=e.find('.comment[data-user="'+__tnt.user.screenName+'"]').length+e.find(".comment.preview").length,storedJSON={c:i,t:m,data:{comment:t.comment,parent_uuid:t.parent_uuid}},o.push(storedJSON);var c=$("#asset-content").attr("data-asset-uuid");try{sessionStorage.setItem("comment-previews-"+c,JSON.stringify(o)),n=!0}catch(r){}}}catch(r){}return n},fetch:function(){var t=$("#asset-content").attr("data-asset-uuid"),e="comment-previews-"+t,n=[],o="";try{window.sessionStorage&&(o=sessionStorage.getItem(e),null!=o&&(n=JSON.parse(o)))}catch(a){}return n},filter:function(t,e,n){var o=$("#asset-content").attr("data-asset-uuid"),a=e.find('.comment[data-user="'+__tnt.user.screenName+'"]'),m=a.length,i=new Date,c=[];if("undefined"!=typeof t)var t=__tnt.comment.preview.fetch();if("undefined"==typeof n&&(n=!1),t&&$.each(t,function(){var t=!1;this.c<m&&(t=!0),!t&&i.getTime("u")-this.t>48e4&&(t=!0),t||c.push(this)}),n)try{sessionStorage.setItem("comment-previews-"+o,JSON.stringify(c))}catch(r){}return c},clear:function(){var t=$("#asset-content").attr("data-asset-uuid");try{sessionStorage.setItem("comment-previews-"+t,null)}catch(e){}}},__tnt.comment.pending={fetch:function(){var t=$("#comment-index").attr("data-asset-uuid"),e="comment-changes-"+t,n=[],o="";try{window.sessionStorage&&(o=sessionStorage.getItem(e),null!=o&&(n=JSON.parse(o)))}catch(a){}return n},process:function(t){t.length&&($(".warning-changes-pending").show(),$.each(t,function(){var t=$("#comment-"+this.data.comment_uuid);__tnt.comment.pending.mark(t)}))},mark:function(t){$(".warning-changes-pending").show(),t.find(".comment-body").append('<span class="label label-warning">Changes pending</span>'),t.siblings(".contribute-tools").find("button.edit, button.approve, button.deny").prop("disabled",!0)},filter:function(t,e,n){var o=e.find(".comment"),a=o.length,m=e.data("asset-uuid"),i=new Date,c=[];if("undefined"!=typeof t)var t=__tnt.comment.pending.fetch();if("undefined"==typeof n&&(n=!1),$.each(t,function(){var t=!1;this.c<a&&(t=!0),!t&&i.getTime("u")-this.t>48e4&&(t=!0),t||c.push(this)}),n)try{sessionStorage.setItem("comment-changes-"+m,JSON.stringify(c))}catch(r){}return c},has_value:function(t,e,n){return t.hasOwnProperty(e)&&t[e]===n},store:function(t,e){var n=!1,o=0;try{if(window.sessionStorage){var a=$("#comment-index").attr("data-asset-uuid"),m=new Array,i=new Date,c=i.getTime("u");null!=sessionStorage.getItem("comment-changes-"+a)&&(m=JSON.parse(sessionStorage.getItem("comment-changes-"+a))),o=e.find(".comment").length,storedJSON={c:o,t:c,data:{comment_uuid:t.comment_uuid}};for(var r=!1,s=0;s<m.length;s++)if(__tnt.comment.pending.has_value(m[s].data,"comment_uuid",storedJSON.data.comment_uuid)){r=!0;break}if(r===!1){m.push(storedJSON);try{sessionStorage.setItem("comment-changes-"+a,JSON.stringify(m)),n=!0}catch(d){}}}}catch(d){}return n}},$(function(){null==__tnt.user.screenName||null==__tnt.user.authToken?__tnt.comment.preview.clear():(previews=__tnt.comment.preview.filter(__tnt.comment.preview.fetch(),$("#comment-area"),!0),__tnt.comment.preview.append(previews,$("#comment-area"))),window.location.pathname.indexOf("users/admin/business/comment")>-1&&null!=__tnt.user.screenName&&(changes_pending=__tnt.comment.pending.filter(__tnt.comment.pending.fetch(),$("#comment-index"),!0),__tnt.comment.pending.process(changes_pending)),__tnt.emoticon.handle($(".comment .comment-text")),$("#commentPost, #commentEdit").find(".comment-emoticons-selector").on("click",function(t){t.preventDefault()}),__tnt.emoticon.handle($("#commentPost, #commentEdit").find(".emoticon-selector li a")),$("#commentPost, #commentEdit").find(".emoticon-selector li a").on("click",function(t){t.preventDefault();var e=$(this).attr("title"),n=$("#commentPost, #commentEdit").find("textarea");n.val(n.val()+e)}),$("a.comment-post").on("click",function(t){t.preventDefault(),__tnt.comment.post.clear($("#commentPost"));var e="";"undefined"!=typeof $(this).attr("data-comment-id")&&(e=$(this).attr("data-comment-id")),__tnt.comment.post.prepare($("#commentPost"),e),$("#commentPostModal").modal({backdrop:"static",keyboard:!0,show:!0,remove:!1})}),$("#commentPost").on("submit",function(t){t.preventDefault(),$("#commentPostModal").find("button,textarea").attr("disabled",""),$("#commentPostModal").find("button[type=submit]").button("loading");var e=__tnt.comment.post.data($("#commentPost"));""!=e.comment&&$.ajax({type:"POST",url:$("#commentPost").attr("action"),data:e,success:function(t){if(t.success){__tnt.trackEvent({network:"Site",socialAction:"comment",url:window.location.href.split("?")[0]}),$("#commentPostModal").modal("hide"),$("#commentPostModal").find("button,textarea").removeAttr("disabled");var t=__tnt.comment.post.data($("#commentPost"));__tnt.comment.preview.store(t,$("#comment-area")),__tnt.comment.preview.create(t,$("#commentPost").find(".template.success"),$("#comment-area")),__tnt.comment.post.clear($("#commentPost"))}else{if(t.error.includes("update your profile")){var e='<a href="'+__tnt.scrubUrl(window.location.origin)+"/users/admin/profile/edit/?mode=contact_info&referer_url="+window.location.href+'" title="Update profile">update your profile</a>';t.error=t.error.replace("update your profile",e)}$("#commentPostModal").find(".alert.alert-info").html(t.error).show(),$("#commentPostModal").find("button,textarea").removeAttr("disabled"),$("#commentPostModal").find("button[type=submit]").button("reset"),$("#commentPostModal").modal("show")}null==__tnt.user.authToken&&($("#commentPostModal").find(".tncms-captcha-image").trigger("click"),$("#commentPostModal").find("input[name=tncms_captcha_response]").val(""))}})}),$("#comments").find(".report").on("click",function(t){t.preventDefault(),__tnt.comment.abuse.prepare($("#commentReport"),$(this).attr("data-comment-id")),$("#commentReportModal").modal({backdrop:"static",keyboard:!0,show:!0,remove:!1})}),$("#comments").find(".watch").on("click",function(t){t.preventDefault(),$("#commentSubscribeModal").modal({backdrop:"static",keyboard:!0,show:!0,remove:!1})}),__tnt.comment.subscribe.prepare(),jQuery("#commentSubscribe").bind("submit",function(t){t.preventDefault(),$("#commentSubscribeModal").modal("hide"),$.post($("#commentSubscribe").attr("action"),{id:$("#commentSubscribe").find("input[name=id]").val(),app:$("#commentSubscribe").find("input[name=app]").val()}).done(function(){try{window.localStorage&&(localStorage.getItem("comment-subscribed-"+$("#asset-content").attr("data-asset-uuid"))?__tnt.comment.subscribe.unset():__tnt.comment.subscribe.set())}catch(t){}__tnt.comment.subscribe.toggle()}).fail(function(){})}),$("#comments").find(".comment-options").on("click",function(t){t.preventDefault()}),$("#commentReport").submit(function(t){t.preventDefault(),$("#commentReportModal").find("button").attr("disabled",""),$("#commentReportModal").find("button[type=submit]").button("loading");var e=$(this),n=e.find("input[name=comment_id]").val();""!=n&&$.post(e.attr("action"),{action:"comments:abuse",comment_id:n}).done(function(){$("#commentReportModal").modal("hide"),$("#commentReportModal").find("button[type=submit]").button("reset"),e.find("input[name=comment_id]").val(""),__tnt.template(document.getElementById("commentReportSuccessTemplate"),document.getElementById("comment-"+n),!0),$("#comment-"+n).find(".comment-heading").first().hide(),$("#comment-"+n).find(".comment-body").first().hide()}).fail(function(){__tnt.template(document.getElementById("commentReportErrorTemplate"),document.getElementById("#commentReport"),!0)})}),$("button.comment-edit").on("click",function(){var t=$(this).parents(".contribute-tools").siblings(".comment"),e=t.find(".comment-text p").html();$('#commentEditModal form textarea[name="content"]').val(e.replace(/<br>/g,"\n")),$('#commentEditModal form input[name="commentid"]').val(t.data("comment-uuid")),$("#commentEditModal").modal({backdrop:"static",keyboard:!0,show:!0,remove:!1})}),$("#commentEdit").on("submit",function(t){t.preventDefault();var e=$("#commentEdit").serialize();$("#commentEditModal").find("button,textarea").prop("disabled",!0),$("#commentEditModal").find("button[type=submit]").button("loading"),""!=e.content&&$.ajax({type:"POST",url:$("#commentEdit").attr("action"),data:e,success:function(){$("#commentEditModal").modal("hide"),$("#commentEditModal").find("button,textarea").prop("disabled",!1);var t=$("#commentEdit").find('input[name="commentid"]').val();__tnt.comment.pending.store({comment_uuid:t},$("#comment-index")),__tnt.comment.pending.mark($("#comment-"+t))}})}),$("#comment-index .contribute-tools .approve").click(function(){var t=$(this),e=t.parents(".contribute-tools").siblings(".comment").data("comment-uuid"),n=$("#comment-index").data("asset-uuid");$.ajax({type:"POST",url:location.href,data:{submit:"approve",commentid:e,assetid:n},success:function(){__tnt.comment.pending.store({comment_uuid:e},$("#comment-index")),__tnt.comment.pending.mark($("#comment-"+e))}})}),$("#comment-index .contribute-tools a.deny").click(function(){var t=$(this),e=t.parents(".contribute-tools").siblings(".comment").data("comment-uuid"),n=$("#comment-index").data("asset-uuid"),o=t.data("reason");$.ajax({type:"POST",url:location.href,data:{submit:"deny",commentid:e,assetid:n,reason:o},success:function(){__tnt.comment.pending.store({comment_uuid:e},$("#comment-index")),__tnt.comment.pending.mark($("#comment-"+e))}})})});
//# sourceMappingURL=tnt.comment.ab5fb87419367af823185ae92fe15663.js.map